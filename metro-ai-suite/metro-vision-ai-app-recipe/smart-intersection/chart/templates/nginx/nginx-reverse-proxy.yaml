apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-reverse-proxy-config
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        upstream smart_intersection_web {
            server smart-intersection-web:443;
        }
        
        upstream grafana {
            server smart-intersection-grafana:3000;
        }
        
        upstream influxdb {
            server influxdb2:8086;
        }
        
        upstream nodered {
            server smart-intersection-nodered:1880;
        }
        
        upstream dlstreamer {
            server smart-intersection-dlstreamer-pipeline-server:8080;
        }
        
        # HTTP server - redirect to HTTPS
        server {
            listen 80;
            return 301 https://$host$request_uri;
        }
        
        # HTTPS server
        server {
            listen 443 ssl;
            server_name _;
            
            # SSL configuration using cert-manager generated certificates
            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;
            
            # SSL security settings
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers HIGH:!aNULL:!MD5;
            ssl_prefer_server_ciphers on;
            
            # Security headers
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-XSS-Protection "1; mode=block";
            
            # Smart Intersection API endpoints (more specific than /api/)
            location /api/v1/ {
                proxy_pass https://smart_intersection_web/api/v1/;
                proxy_ssl_verify off;
                proxy_ssl_session_reuse on;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_redirect off;
            }
            
            # DL Streamer Pipeline Server (for /api/pipelines/* etc.)
            location /api/ {
                proxy_pass http://dlstreamer/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_redirect off;
            }
            
            # Grafana dashboard
            location /grafana/ {
                proxy_pass http://grafana;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # WebSocket support for Grafana
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                
                # Allow iframe embedding for Grafana
                add_header X-Frame-Options ALLOWALL always;
                add_header Content-Security-Policy "frame-ancestors *" always;
            }
            
            # Node-RED dashboard
            location /nodered/ {
                proxy_pass http://nodered/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # WebSocket support for Node-RED
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_redirect off;
            }
            
            # InfluxDB Web UI - Both proxy and direct access available
            # Direct access: http://<HOST_IP>:30086 - Fully functional
            # Proxy access: https://<HOST_IP>:30443/influxdb/ - Basic functionality + API access
            location /influxdb {
                return 301 https://$host/influxdb/;
            }
            
            location /influxdb/ {
                # Remove the /influxdb prefix when proxying to backend
                rewrite ^/influxdb/(.*) /$1 break;
                proxy_pass http://influxdb;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # Handle redirects properly
                proxy_redirect http://influxdb/ /influxdb/;
                proxy_redirect https://influxdb/ /influxdb/;
            }
            
            # InfluxDB API access through proxy
            location /api/influxdb/ {
                proxy_pass http://influxdb/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_redirect off;
            }
            
            # Smart Intersection Web Interface - Main UI
            location / {
                proxy_pass https://smart_intersection_web/;
                proxy_ssl_verify off;
                proxy_ssl_session_reuse on;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # WebSocket support for real-time updates
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                
                # Handle SceneScape authentication (matching Docker Compose)
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header X-Forwarded-Server $host;
            }
            
            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }

---
apiVersion: v1
kind: Secret
metadata:
  name: nginx-reverse-proxy-tls
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F3SUJBZ0lVTnQvZldMdERKVCtaUjBuWWt6TVRBZ3dSK05nd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0dURVhNQlVHQTFVRUF3d09jMjFoY25RdGFXNTBaWEp6WldOMGFXOXVNQjRYRFRJMU1UQTJNRFV4TXpVegpPRm9YRFRJMU1USXpNRFV4TXpVek9Gb3dHVEVYTUJVR0ExVUVBd3dPYzIxaGNuUXRhVzUwWlhKelpXTjBhVzl1Ck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBcUdoaTJLcElHRGo5Nk5jczB2VHIKRjVoV3ViMnFMN3pYVzBSWW5reWhjMk12L1o3aXphV1FCZjc1cG1zMFpGWDRyQVh5SVhoSk1VemhPOUxKVVo2TQpXSWNVdENGNjdOYzJNeGFBbHo1bFhiVUN6K3VuNUQ4K3JNL3MrMG9qYm1sVms3ZzYrbEE3M2VveWR3Z1duaXFCCjg4R25hbXFmK1ZlcWF5bXFrZzYrbFo1NytmR2NLMW8rRXJ5dlhUZlNYSTVxaEVRcjlOVGVLQjBkdGpCOGxLcTcKY2p4dCtKZDBHZnZOOUZWTlFSMS9pWGVCbm1MTVVFaDFKcHh0TmNBZHpNdGpiRlloUEFKbzZaVWFhVkdpTFJsYwptUGY1SEZuTkRJREJDQ2NZN2M5RUNvWTZJcmZYNlI4bHNhY0J5RDJCR1ViMWQwMXdYZVRTUGNFNXJ6bHFBQkJVCmJRSURBUUFCbzFNd1VUQWRCZ05WSFE0RUZnUVVZTElJWm5pczRYamVEQnMrWkd4SWFIaWFpLzR3SHdZRFZSMGoKQkJnd0ZvQVVZTElJWm5pczRYamVEQnMrWkd4SWFIaWFpLzR3RHdZRFZSMFRBUUgvQkFVd0F3RUIvekFOQmdrcQpoa2lHOXcwQkFRc0ZBQU9DQVFFQVJObVFadVF6K21STFZxUXZ1ZjlXbHlXOGlDb0RtaWRIcXZVN1piZlkxUkJmCmJjTm9yOWVCQU40Y0U4ZVE0WDBUQ0ttTHRaN1lrNnNkNytuSnk4OHFZNGY2Y1BNMHh3Y1QxOCtXRFBtRDJ0K2cKZFpQdDZ5K1N3STFxelVlSjJOVVlzT1hkSFBBdjFNcHNtaE9uWTFmaWI5VzdOSFFmckNOdGpyRWRFT01vZTlzQQpKakc2VjRrdUpKT3ZEWGh1cHhBTnBFYWpDMGdudVBvT2dCVlZmUXJOQ0k1RDRYQ3djamxFVkgwZ2J2UEJtNE5nCmlPYUtoUHlrUERucW96a1ZIYmJKK0ROUVVKZ3JpQkRaVmRDM0pUTDZGRjNMMm1MbWErbVNGQk1ZNFc3UCtqT3AKSStGZEJNUGdZeXV4enpvUkpCVmJYeUJMN25IUjlkN1J3YzlGaVlMa2FRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ29hR0xZcWtnWU9QM28KMXR6UzlPc1htRmE1dmFvdnZOZGJSRmllVEtGell5LzludUxOcFpBRi92bW1helJrVmZpc0JmSWhlRWt4VE9FNwowc2xSbm94WWh4UzBJWHJzMXpZekZvQ1hQbVZkdFFMUDY2ZmtQejZzeit6N1NpTnVhVldUdURyNlVEdmQ2aksKM0NCYWVLB0h6d2FkcWFwLzVWNnByS2FxU0RyNlZubnY1OFp3cldqNFN2SzlkTjlKY2ptcUVSQ3YwMU40b0hSMgoyTUh5VXFydHlQRzM0bDNRWis4MzBWVTFCSFgrSmQ0R2VZc3hRU0hVbW5HMDFwQjNNeTJOc1ZpRThBbWpwbFJwCnBVYUl0R1Z5WTkva2NXYzBNZ01FSUpqaDNEdzBoam9pdDlmcEh5V3hwd0hJUFlFWlJ2VjNUWEJkNU5JOXdUbXYKT1dvQUVGUlNBZ01CQUFFQ2dnRUFWd1VRUHovQTcvWXZMNGtOd0JMc0d5L1NjNnA2VnBCSmNSVGFkaGlyS05KNQpSaHZhRlV2alFTaE0wd0Erb1VBdjc1VW8yOVlOdkVHeDVITGhGa0Y4YjJvRzZ1Sk0xWUYrR1V4ZWNHQWtKNlNEClRZNWF6cFlVRVVQQ3ZWWGxrNXRkRUZlU1NPZURnaVJkMWV5UGhvd0hoNFVHRG5TVGJFeUhXb0w0YkZQRHNHM1AKSzVkb1U3ekU3SGwwSE9LeFV2ZnRJcXdhZVhHTWNNRGNMT3VtQWl6UnBkaVQyTFNQY1RNOXNYamVKVDFINENzYQpCNWh1WTFrcHBaKzZsa2U4NmVLc3VvVXI3N0JZdWF5TCtZTUdvZjVhY3NBMGw4NmxOd3pIV0NqUzUrTUpoMTR3CnlMNEhSUi8wa2dxK0V1TXF5Zzd0T2g1QXZaT0N5TmNFeCtxaURRS0JnUURSd0UrcG5EbTJ1Q1dGZXJJczBYaTMKd1RvRlBQQk54UjJkK1JQV1FMZlNWeGNPNmJWZXQ0YUJ4N0NvYW1Gakt2QStsUzUwQVBHRkpnc2g4RGp3aThzNgp6cGpyNlc5TUJqNGNlaVBNZGNEZUJaZm5OM2dVSDdOUVAraU1oZ05aRnljTGlBbnQzc2hCVCtyLzY3aDBJbzhKClJ1MDJydjNxUENyOTVFbHE3VCtqY1FLQmdRRE1IdHZsMTlYb1R6SGtmdGRyRjNVdGNEUXE3dG5UTk9EOG54Y0QKeWhOSWhBMG1rNDZjV0QwL0hLZkhINGNsKzBxUzgvSEVJWlp1M0xCYTJNaVBHMWJNVW5JTktrd0NlcnNrRUFrVgpnZVVhWTh1akk0K2ozZWliN0UwZS80Q3Z0U3VqZ1FnaTlYdWFBSHdGWWRGSFpIejJLdCtnSkhEQXNubkNaUTNTCmV5SGx4UUtCZ0JpVGNHM29GYzNXOUN0eGNMRlJPNktQZ2trYVNuSXNkN3pOZk93R1l1ZkpxMGpSZjJEaWZYTkwKSGUwcEJGSGlnTFI3WFhDOEx2ZVNnNE1pMmY2K25ZRXhOWXI3OWwxOTZUbE9DUmlQQ0VXUjdZUHBoVVBDdkpIZQpucFR5KzA4K2swRlBKbCtCTGRKbms5aDlrNUt1ODB4VkNRZGxjRkFJcWdCQUZaNjk0aFh6QW9HQUJEQkQxTzg0CnJBYkZnT3k0S2ZoUmlxTjg5QVgvazNSaU9kME1IcDlVVGJwV2VDYUQ5VERtZUMrKzRGQzZwbEZkdUxDWHNJbTgKNHNJdHNSL0J6N3FqZHJzNFptNjNCSDVqcm5ycXk2ejQ2RmFKVjIzSkgxSVBkYUN0VG1LNldwZUFtNUFKWlQ4OAovQ1U2a1F5YXdDdTBnRHY4eENIR29lQ1ROOWdJYm5qMVJJRUNnWUVBMk9VcVc2V1pGanBoOUZ5eTVWeWE1MUs1CmJFZTdxSGw5VHBQT2dMNjNtOTYxaDJsR2xxWXNOUkFGcWJ0ejJKTW9jNzNvVHorNlVveTNOTGxkT1FPbXZ1RVUKNFBSVUhEZHJacVU5OXB6RzIvYVptRWNkY3huZkxDak1CMVc2YzJwSWhmQ0JkODZLOC9mZWY3a3NQUEdXdzFIVAordEc4SUNWZWI2OXJBZzNkc0E9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-reverse-proxy
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
  labels:
    app: nginx-reverse-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-reverse-proxy
  template:
    metadata:
      labels:
        app: nginx-reverse-proxy
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        env:
        - name: http_proxy
          value: {{ .Values.http_proxy }}
        - name: https_proxy
          value: {{ .Values.https_proxy }}
        - name: no_proxy
          value: {{ .Values.no_proxy }}
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: nginx-tls
          mountPath: /etc/nginx/ssl
          readOnly: true
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-reverse-proxy-config
      - name: nginx-tls
        secret:
          secretName: nginx-reverse-proxy-tls

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-reverse-proxy
  namespace: {{ .Values.global.namespace | default .Release.Namespace }}
spec:
  type: NodePort
  selector:
    app: nginx-reverse-proxy
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30080
  - name: https
    port: 443
    targetPort: 443
    nodePort: 30443